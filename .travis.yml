dist: xenial   # required for Python >= 3.7
jobs:
  include:
    - name: "Python 3.6 on Linux"
      language: python
      python: 3.6
    - name: "Python 3.7 on Linux"
      language: python
      python: 3.7
    - name: "Python 3.8 on Linux"
      language: python
      python: 3.8
    - name: "Python dev on Linux"
      language: python
      python: nightly
    - name: "Python 3.7.4 on MacOS"
      os: osx
      osx_image: xcode11.2  # Python 3.7.4 running on macOS 10.14.4
      language: shell       # 'language: python' is an error on Travis CI macOS
      before_install:
        - pip3 install poetry~=0.12.17
    - name: "Python 3.8.0 on Windows"
      os: windows
      langage: shell       # 'language: python' is an error on Travis CI Windows
      before_install:
        - choco install python --version 3.8.0
        - python -m pip install --upgrade pip
        - pip install poetry~=0.12.17
  allow_failures:
    - python: 3.8
    - python: nightly
git:
  depth: false
cache: pip
before_install:
  - pip install poetry~=0.12.17
install:
  # we run `poetry version` here to appease poetry about '0.0.0-source'
  - poetry version
  - poetry install
script:
  - poetry run python --version
  - poetry run behave
before_deploy:
  - poetry config http-basic.pypi $PYPI_USER $PYPI_PASS
  - poetry version $TRAVIS_TAG
  - poetry build
deploy:
  - provider: script
    script: poetry publish
    skip_cleanup: true
    on:
      branch: master
      tags: true
after_deploy:
  - git config --global user.email "jrnl.bot@gmail.com"
  - git config --global user.name "Jrnl Bot"
  - git checkout master
  - git add pyproject.toml
  - git commit -m "Incrementing version to ${TRAVIS_TAG}"
  - git push https://${GITHUB_TOKEN}@github.com/jrnl-org/jrnl.git master
